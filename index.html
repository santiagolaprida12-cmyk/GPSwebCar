<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Prueba BLE - MLT-BT05 (FFE0/FEE0)</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    #log { border: 1px solid #ccc; padding: 10px; height: 200px; overflow-y: scroll; }
  </style>
</head>
<body>
  <h1>Prueba BLE - MLT-BT05</h1>
  <button id="connect">Conectar</button>
  <input id="msg" type="text" placeholder="Escribe..." />
  <button id="send">Enviar</button>
  <h3>Log:</h3>
  <div id="log"></div>

<script>
let device, server, service, characteristic;

// UUIDs correctos (hexadecimal con ceros, no letras O)
const possibleUUIDs = [0xFFE0, 0xFEE0];

async function connect() {
  try {
    device = await navigator.bluetooth.requestDevice({
      filters: [{ namePrefix: 'MLT-BT05' }],
      optionalServices: possibleUUIDs
    });

    server = await device.gatt.connect();
    log("üîó Conectado a " + device.name);

    // Intentar con todos los UUID hasta encontrar el v√°lido
    for (let uuid of possibleUUIDs) {
      try {
        log("‚è≥ Probando servicio " + uuid.toString(16));
        service = await server.getPrimaryService(uuid);
        characteristic = await service.getCharacteristic(uuid);

        // Si llegamos ac√°, se encontr√≥ el correcto
        log("‚úÖ Servicio encontrado: " + uuid.toString(16));

        characteristic.startNotifications();
        characteristic.addEventListener('characteristicvaluechanged', e => {
          let value = new TextDecoder().decode(e.target.value);
          log("RX: " + value);
        });

        break; // salir del loop
      } catch (err) {
        log("‚ö†Ô∏è No funcion√≥ con UUID " + uuid.toString(16));
      }
    }

  } catch (err) {
    log("‚ùå Error: " + err);
  }
}

function send() {
  let text = document.getElementById("msg").value + "\n";
  if (characteristic) {
    let data = new TextEncoder().encode(text);
    characteristic.writeValue(data);
    log("TX: " + text);
  } else {
    log("‚ö†Ô∏è No hay caracter√≠stica activa.");
  }
}

function log(msg) {
  let div = document.getElementById("log");
  div.innerHTML += msg + "<br>";
  div.scrollTop = div.scrollHeight;
}

document.getElementById("connect").onclick = connect;
document.getElementById("send").onclick = send;
</script>
</body>
</html>
