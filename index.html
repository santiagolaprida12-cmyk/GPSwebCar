<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Prueba BLE - MLT-BT05 (FFEO/FEEO)</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    #log { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll; }
    button, input { margin: 5px; }
  </style>
</head>
<body>
  <h1>Prueba BLE - MLT-BT05</h1>
  <button id="connect">Conectar</button>
  <input id="msg" type="text" placeholder="Escribe algo..." />
  <button id="send">Enviar</button>
  <h3>Log:</h3>
  <div id="log"></div>

<script>
let device, server, service, characteristic;

// UUIDs de tus servicios detectados
const possibleUUIDs = [0xFFE0, 0xFEE0];

function log(msg) {
  const div = document.getElementById("log");
  div.innerHTML += msg + "<br>";
  div.scrollTop = div.scrollHeight;
}

async function connectBLE() {
  try {
    device = await navigator.bluetooth.requestDevice({
      filters: [{ namePrefix: 'MLT-BT05' }],
      optionalServices: possibleUUIDs
    });

    log("üîó Dispositivo seleccionado: " + device.name);

    server = await device.gatt.connect();
    log("‚úÖ Conectado al servidor GATT");

    // Intentar con los servicios hasta encontrar uno v√°lido
    for (let uuid of possibleUUIDs) {
      try {
        service = await server.getPrimaryService(uuid);
        characteristic = await service.getCharacteristic(uuid);

        // Habilitar notificaciones
        await characteristic.startNotifications();
        characteristic.addEventListener('characteristicvaluechanged', e => {
          const value = new TextDecoder().decode(e.target.value);
          log("RX: " + value);
        });

        log("‚úî Servicio v√°lido encontrado: " + uuid.toString(16));
        break; // salimos del loop
      } catch (err) {
        log("‚ö† No funcion√≥ con UUID " + uuid.toString(16));
      }
    }

  } catch (err) {
    log("‚ùå Error al conectar: " + err);
  }
}

async function sendBLE() {
  const text = document.getElementById("msg").value + "\n";
  if (characteristic) {
    const data = new TextEncoder().encode(text);
    await characteristic.writeValue(data);
    log("TX: " + text);
  } else {
    log("‚ö† No hay caracter√≠stica activa");
  }
}

document.getElementById("connect").onclick = connectBLE;
document.getElementById("send").onclick = sendBLE;
</script>
</body>
</html>
