<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Carrito GPS Web</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
  body { margin:0; font-family: Arial; display:flex; height:100vh; }
  #panel { width:300px; padding:10px; background:#f0f0f0; box-sizing:border-box; overflow-y:auto; }
  #map { flex:1; }
  button { margin:5px 0; width:100%; padding:10px; }
  #log { border:1px solid #ccc; height:200px; overflow-y:scroll; padding:5px; background:#fff; }
  .modo { font-weight:bold; margin-top:10px; }
</style>
</head>
<body>

<div id="panel">
  <h2>Carrito GPS</h2>
  
  <div class="modo">Modo:</div>
  <select id="modo">
    <option value="manual">Manual</option>
    <option value="automatico">Autom√°tico</option>
    <option value="test">Test</option>
  </select>

  <div id="manualControls">
    <button id="fwd">‚Üë Adelante</button>
    <button id="left">‚Üê Izquierda</button>
    <button id="stop">‚ñ† Stop</button>
    <button id="right">‚Üí Derecha</button>
    <button id="back">‚Üì Atr√°s</button>
  </div>

  <div id="autoControls">
    <input type="text" id="destLat" placeholder="Latitud destino">
    <input type="text" id="destLon" placeholder="Longitud destino">
    <button id="go">GO</button>
  </div>

  <button id="clearLog">üóë Limpiar visor</button>
  <button id="connectBT">Conectar Bluetooth</button>
  
  <h3>Visor:</h3>
  <div id="log"></div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let modoSelect = document.getElementById('modo');
let manualControls = document.getElementById('manualControls');
let autoControls = document.getElementById('autoControls');
let logDiv = document.getElementById('log');

let port, reader, writer;

function log(msg) {
  logDiv.innerHTML += msg + "<br>";
  logDiv.scrollTop = logDiv.scrollHeight;
}

// Leaflet mapa satelital
const map = L.map('map').setView([-34.405265, -59.851471], 16);
L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/satellite-v9/tiles/{z}/{x}/{y}?access_token=YOUR_MAPBOX_TOKEN', {
    maxZoom: 20,
    tileSize: 512,
    zoomOffset: -1,
    attribution: '¬© Mapbox'
}).addTo(map);

let carritoMarker = L.marker([-34.405265, -59.851471], {icon: L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/743/743131.png', iconSize:[32,32]})}).addTo(map);
let destinoMarker;

function actualizarCarrito(lat, lon){
  carritoMarker.setLatLng([lat, lon]);
  map.panTo([lat, lon]);
}

// Cambiar modo
modoSelect.addEventListener('change', ()=>{
  let modo = modoSelect.value;
  if(modo==='manual'){
    manualControls.style.display='block';
    autoControls.style.display='none';
  }else{
    manualControls.style.display='none';
    autoControls.style.display='block';
  }
});

// Limpiar visor
document.getElementById('clearLog').addEventListener('click', ()=>{
  logDiv.innerHTML = '';
});

// Conectar HC-05/MLT-BT05 cl√°sico
document.getElementById('connectBT').addEventListener('click', async ()=>{
  try{
    port = await navigator.serial.requestPort();
    await port.open({ baudRate: 9600 });
    log("üîó Conectado al Bluetooth Serial");

    writer = port.writable.getWriter();
    reader = port.readable.getReader();
    leerLoop();
  }catch(err){ log("‚ùå Error: "+err); }
});

async function leerLoop(){
  try{
    while(true){
      const { value, done } = await reader.read();
      if(done) break;
      if(value){
        let texto = new TextDecoder().decode(value);
        log("RX: "+texto);
        // Si env√≠a LAT=... LON=... actualizar marcador
        let latMatch = texto.match(/LAT=([0-9\.-]+)/);
        let lonMatch = texto.match(/LON=([0-9\.-]+)/);
        if(latMatch && lonMatch){
          actualizarCarrito(parseFloat(latMatch[1]), parseFloat(lonMatch[1]));
        }
      }
    }
  }catch(err){ log("‚ùå Error lectura: "+err); }
}

async function enviar(msg){
  if(writer){
    await writer.write(new TextEncoder().encode(msg+"\n"));
    log("TX: "+msg);
  }else{
    log("‚ö† No conectado al Serial");
  }
}

// Botones manual
document.getElementById('fwd').addEventListener('click', ()=>enviar('M F'));
document.getElementById('back').addEventListener('click', ()=>enviar('M B'));
document.getElementById('left').addEventListener('click', ()=>enviar('M L'));
document.getElementById('right').addEventListener('click', ()=>enviar('M R'));
document.getElementById('stop').addEventListener('click', ()=>enviar('M S'));

// GO destino
document.getElementById('go').addEventListener('click', ()=>{
  let lat = document.getElementById('destLat').value;
  let lon = document.getElementById('destLon').value;
  if(lat && lon){
    if(destinoMarker) map.removeLayer(destinoMarker);
    destinoMarker = L.marker([lat, lon], {icon:L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/684/684908.png', iconSize:[32,32]})}).addTo(map);
    enviar(`GO ${lat} ${lon}`);
  }else{
    alert("Ingresar latitud y longitud de destino");
  }
});
</script>
</body>
</html>
